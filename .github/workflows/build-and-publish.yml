name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - master
      - dev
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKERHUB: docker.io

jobs:
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Debug trigger
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Service: backend"
          
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKERHUB }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        
      - name: Prepare Docker tags
        id: docker_tags
        run: |
          # Convert repository name to lowercase for ghcr.io compatibility
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Define image names for both registries
          GHCR_IMAGE="${{ env.REGISTRY_GHCR }}/${REPO_LOWER}-backend"
          DOCKERHUB_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-backend"
          
          TAGS=""
          
          echo "Processing ref_type: ${{ github.ref_type }}"
          echo "Processing ref: ${{ github.ref }}"
          echo "Processing ref_name: ${{ github.ref_name }}"
          
          # Handle tagged releases
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "Processing tag release"
            VERSION="${{ github.ref_name }}"
            
            # Remove 'v' prefix if present for clean version tag
            if [[ $VERSION == v* ]]; then
              CLEAN_VERSION=${VERSION#v}
              TAGS="$GHCR_IMAGE:$CLEAN_VERSION,$GHCR_IMAGE:$VERSION,$DOCKERHUB_IMAGE:$CLEAN_VERSION,$DOCKERHUB_IMAGE:$VERSION"
            else
              TAGS="$GHCR_IMAGE:$VERSION,$DOCKERHUB_IMAGE:$VERSION"
            fi
            
            # Always tag latest for version releases
            TAGS="$TAGS,$GHCR_IMAGE:latest,$DOCKERHUB_IMAGE:latest"
            
            echo "Version tags: $TAGS"
            
          # Handle branch pushes
          elif [[ "${{ github.ref_type }}" == "branch" ]]; then
            echo "Processing branch release"
            
            # Add branch-specific tags
            if [[ "${{ github.ref_name }}" == "main" || "${{ github.ref_name }}" == "master" ]]; then
              TAGS="$GHCR_IMAGE:latest,$GHCR_IMAGE:main,$DOCKERHUB_IMAGE:latest,$DOCKERHUB_IMAGE:main"
            elif [[ "${{ github.ref_name }}" == "dev" ]]; then
              TAGS="$GHCR_IMAGE:dev,$DOCKERHUB_IMAGE:dev"
            else
              # For other branches, use branch name (sanitized)
              BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
              TAGS="$GHCR_IMAGE:$BRANCH_NAME,$DOCKERHUB_IMAGE:$BRANCH_NAME"
            fi
            
            # Add SHA tag for branches
            TAGS="$TAGS,$GHCR_IMAGE:sha-${GITHUB_SHA::7},$DOCKERHUB_IMAGE:sha-${GITHUB_SHA::7}"
          fi
          
          # Add date tag for all builds
          TAGS="$TAGS,$GHCR_IMAGE:${{ steps.date.outputs.date }},$DOCKERHUB_IMAGE:${{ steps.date.outputs.date }}"
          
          # Clean up any leading commas
          TAGS=$(echo "$TAGS" | sed 's/^,*//')
          
          echo "Final tags: $TAGS"
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "ghcr_image=$GHCR_IMAGE" >> $GITHUB_OUTPUT
          echo "dockerhub_image=$DOCKERHUB_IMAGE" >> $GITHUB_OUTPUT
          
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          tags: ${{ steps.docker_tags.outputs.tags }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Debug trigger
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Service: frontend"
          
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKERHUB }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        
      - name: Prepare Docker tags
        id: docker_tags
        run: |
          # Convert repository name to lowercase for ghcr.io compatibility
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Define image names for both registries
          GHCR_IMAGE="${{ env.REGISTRY_GHCR }}/${REPO_LOWER}-frontend"
          DOCKERHUB_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-frontend"
          
          TAGS=""
          
          echo "Processing ref_type: ${{ github.ref_type }}"
          echo "Processing ref: ${{ github.ref }}"
          echo "Processing ref_name: ${{ github.ref_name }}"
          
          # Handle tagged releases
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "Processing tag release"
            VERSION="${{ github.ref_name }}"
            
            # Remove 'v' prefix if present for clean version tag
            if [[ $VERSION == v* ]]; then
              CLEAN_VERSION=${VERSION#v}
              TAGS="$GHCR_IMAGE:$CLEAN_VERSION,$GHCR_IMAGE:$VERSION,$DOCKERHUB_IMAGE:$CLEAN_VERSION,$DOCKERHUB_IMAGE:$VERSION"
            else
              TAGS="$GHCR_IMAGE:$VERSION,$DOCKERHUB_IMAGE:$VERSION"
            fi
            
            # Always tag latest for version releases
            TAGS="$TAGS,$GHCR_IMAGE:latest,$DOCKERHUB_IMAGE:latest"
            
            echo "Version tags: $TAGS"
            
          # Handle branch pushes
          elif [[ "${{ github.ref_type }}" == "branch" ]]; then
            echo "Processing branch release"
            
            # Add branch-specific tags
            if [[ "${{ github.ref_name }}" == "main" || "${{ github.ref_name }}" == "master" ]]; then
              TAGS="$GHCR_IMAGE:latest,$GHCR_IMAGE:main,$DOCKERHUB_IMAGE:latest,$DOCKERHUB_IMAGE:main"
            elif [[ "${{ github.ref_name }}" == "dev" ]]; then
              TAGS="$GHCR_IMAGE:dev,$DOCKERHUB_IMAGE:dev"
            else
              # For other branches, use branch name (sanitized)
              BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
              TAGS="$GHCR_IMAGE:$BRANCH_NAME,$DOCKERHUB_IMAGE:$BRANCH_NAME"
            fi
            
            # Add SHA tag for branches
            TAGS="$TAGS,$GHCR_IMAGE:sha-${GITHUB_SHA::7},$DOCKERHUB_IMAGE:sha-${GITHUB_SHA::7}"
          fi
          
          # Add date tag for all builds
          TAGS="$TAGS,$GHCR_IMAGE:${{ steps.date.outputs.date }},$DOCKERHUB_IMAGE:${{ steps.date.outputs.date }}"
          
          # Clean up any leading commas
          TAGS=$(echo "$TAGS" | sed 's/^,*//')
          
          echo "Final tags: $TAGS"
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "ghcr_image=$GHCR_IMAGE" >> $GITHUB_OUTPUT
          echo "dockerhub_image=$DOCKERHUB_IMAGE" >> $GITHUB_OUTPUT
          
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          tags: ${{ steps.docker_tags.outputs.tags }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  build-summary:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch/Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref Type:** ${{ github.ref_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“¦ Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### GitHub Container Registry:" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')-backend\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')-frontend\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### DockerHub:" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-backend\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-frontend\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64, linux/arm/v7" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show tag information
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "**Release Type:** ðŸ·ï¸ Version Tag (\`${{ github.ref_name }}\`)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Release Type:** ðŸŒ¿ Branch Build (\`${{ github.ref_name }}\`)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-backend.result }}" == "success" ] && [ "${{ needs.build-frontend.result }}" == "success" ]; then
            echo "âœ… All builds completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— Quick Links:" >> $GITHUB_STEP_SUMMARY
            echo "- [GitHub Packages](https://github.com/${{ github.repository }}/pkgs/container)" >> $GITHUB_STEP_SUMMARY
            echo "- [DockerHub](https://hub.docker.com/u/${{ secrets.DOCKERHUB_USERNAME }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some builds failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi